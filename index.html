<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .game-container {
            text-align: center;
            position: relative;
            width: 50%;
            height: 100vh;
            margin: 0 auto;
            background-size: cover;
            background-position: center;
            overflow-y: scroll;
        }

        .road {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-image: url('HomePage/road.png');
            background-repeat: no-repeat;
            background-size: contain;
            width: 30%;
            height: 410vh;
        }

        .level {
            background-color: #90c5f3;
            padding: 15px;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            cursor: pointer;
            position: absolute;
            transition: transform 0.3s;
            transform: translate(-50%, -50%);
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .level.disabled {
            background-color: #ccc;
            cursor: not-allowed;
            pointer-events: none;
        }

        .level:hover {
            transform: scale(1.1);
        }

        .stars {
            display: flex;
            justify-content: center;
            margin-top: 5px;
        }

        .stars i {
            font-size: 12px;
            margin: 0 1px;
            color: grey;
        }

        .total-score {
            position: fixed; /* Position fixed to the viewport */
            top: 10px; /* Keep it 10px from the top of the viewport */
            left: 10px; /* Keep it 10px from the left of the viewport */
            font-size: 20px;
            color: #333;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000; /* Ensure it stays on top of other elements */
        }               

        .level1 { top: 393%; left: 51%; }
        .level2 { top: 365%; left: 35%; }
        .level3 { top: 350%; left: 56%; }
        .level4 { top: 336%; left: 42%; }
        .level5 { top: 316%; left: 53%; }

        .level6 { top: 288%; left: 38%; }
        .level7 { top: 268%; left: 57%; }
        .level8 { top: 253%; left: 43%; }
        .level9 { top: 233%; left: 60%; }
        .level10 { top: 203%; left: 38%; }

        .level11 { top: 185%; left: 60%; }
        .level12 { top: 172%; left: 45%; }
        .level13 { top: 145%; left: 60%; }
        .level14 { top: 124%; left: 40%; }
        .level15 { top: 105%; left: 60%; }

        .level16 { top: 87%; left: 47%; }
        .level17 { top: 65%; left: 56%; }
        .level18 { top: 43%; left: 42%; }
        .level19 { top: 23%; left: 61%; }
        .level20 { top: 8%; left: 50%; }

        .player {
            position: absolute;
            width: 50px;
            height: 50px;
            transform: translate(-50%, -50%);
            transition: top 1s, left 1s;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="game-container" id="game-page">
        <div class="total-score" id="totalScore">Total Score: 0</div> <!-- Total score display -->
        <div class="road" id="road"></div>
        <div class="level level20" id="level20" onclick="submitLevel(20)">20
            <div class="stars" id="stars20"></div>
        </div>
        <div class="level level19" id="level19" onclick="submitLevel(19)">19
            <div class="stars" id="stars19"></div>
        </div>
        <div class="level level18" id="level18" onclick="submitLevel(18)">18
            <div class="stars" id="stars18"></div>
        </div>
        <div class="level level17" id="level17" onclick="submitLevel(17)">17
            <div class="stars" id="stars17"></div>
        </div>
        <div class="level level16" id="level16" onclick="submitLevel(16)">16
            <div class="stars" id="stars16"></div>
        </div>
        <div class="level level15" id="level15" onclick="submitLevel(15)">15
            <div class="stars" id="stars15"></div>
        </div>
        <div class="level level14" id="level14" onclick="submitLevel(14)">14
            <div class="stars" id="stars14"></div>
        </div>
        <div class="level level13" id="level13" onclick="submitLevel(13)">13
            <div class="stars" id="stars13"></div>
        </div>
        <div class="level level12" id="level12" onclick="submitLevel(12)">12
            <div class="stars" id="stars12"></div>
        </div>
        <div class="level level11" id="level11" onclick="submitLevel(11)">11
            <div class="stars" id="stars11"></div>
        </div>
        <div class="level level10" id="level10" onclick="submitLevel(10)">10
            <div class="stars" id="stars10"></div>
        </div>
        <div class="level level9" id="level9" onclick="submitLevel(9)">9
            <div class="stars" id="stars9"></div>
        </div>
        <div class="level level8" id="level8" onclick="submitLevel(8)">8
            <div class="stars" id="stars8"></div>
        </div>
        <div class="level level7" id="level7" onclick="submitLevel(7)">7
            <div class="stars" id="stars7"></div>
        </div>
        <div class="level level6" id="level6" onclick="submitLevel(6)">6
            <div class="stars" id="stars6"></div>
        </div>
        <div class="level level5" id="level5" onclick="submitLevel(5)">5
            <div class="stars" id="stars5"></div>
        </div>
        <div class="level level4" id="level4" onclick="submitLevel(4)">4
            <div class="stars" id="stars4"></div>
        </div>
        <div class="level level3" id="level3" onclick="submitLevel(3)">3
            <div class="stars" id="stars3"></div>
        </div>
        <div class="level level2" id="level2" onclick="submitLevel(2)">2
            <div class="stars" id="stars2"></div>
        </div>
        <div class="level level1" id="level1" onclick="submitLevel(1)">1
            <div class="stars" id="stars1"></div>
        </div>
        <img src="user_img/generated_image_no_bg.png" id="player" class="player" alt="Player" style="top: 393%; left: 51%;" />
    </div>

    <script>
        // Global variable to store the selected TV show
        let selectedTVShow = localStorage.getItem('selectedTVShow');

        const levelPositions = [
            { top: '393%', left: '51%' },
            { top: '365%', left: '35%' },
            { top: '350%', left: '56%' },
            { top: '336%', left: '42%' },
            { top: '316%', left: '53%' },

            { top: '288%', left: '38%' },
            { top: '268%', left: '57%' },
            { top: '253%', left: '43%' },
            { top: '233%', left: '60%' },
            { top: '203%', left: '38%' },

            { top: '185%', left: '60%' },
            { top: '172%', left: '45%' },
            { top: '145%', left: '60%' },
            { top: '124%', left: '40%' },
            { top: '105%', left: '60%' },

            { top: '87%', left: '47%' },
            { top: '65%', left: '56%' },
            { top: '43%', left: '42%' },
            { top: '23%', left: '61%' },
            { top: '8%', left: '50%' }
        ];

        const levelScores = Array(20).fill(0);

        const colors = {
            'Spongebob': ['light blue'],
            'PJ Masks': ['green', 'blue', 'red'],
            'Winx Club': ['purple'],
            'Spidey And His Amazing Friends': ['red'],
        };

        function applyLevelColors(showName) {
            const selectedColors = colors[showName];
            const levels = document.querySelectorAll('.level');

            levels.forEach((level, index) => {
                const colorIndex = index % selectedColors.length;
                level.style.backgroundColor = selectedColors[colorIndex];
            });
        }

        function updateStars(level) {
            const score = localStorage.getItem(`level${level}_score`) || 0;
            const starsContainer = document.getElementById(`stars${level}`);
            starsContainer.innerHTML = '';

            for (let i = 1; i <= 3; i++) {
                const star = document.createElement('i');
                star.className = 'fa fa-star';
                star.style.color = 'grey';

                if (i <= score) {
                    star.style.color = 'yellow';
                }

                starsContainer.appendChild(star);
            }

            levelScores[level - 1] = score;
            checkLevelAccessibility();
            updateTotalScore(); // Update total score whenever stars are updated
        }

        function updateTotalScore() {
            let totalScore = 0;
            for (let i = 1; i <= 20; i++) {
                const points = parseInt(localStorage.getItem(`level${i}_points`) || '0');
                totalScore += points;
            }
            document.getElementById('totalScore').innerText = `Total Score: ${totalScore}`;
        }
        
        function checkLevelAccessibility() {
            for (let i = 2; i <= 20; i++) {
                const currentLevel = document.getElementById(`level${i}`);
                const previousLevelScore = levelScores[i - 2];

                if (previousLevelScore === 0) {
                    currentLevel.classList.add('disabled');
                } else {
                    currentLevel.classList.remove('disabled');
                }
            }
        }

        window.onload = function() {
            // First, try to get the tv_show from the URL
            const urlParams = new URLSearchParams(window.location.search);
            let selectedTVShow = urlParams.get('tv_show');
        
            // If tv_show is not in the URL, try to get it from localStorage
            if (!selectedTVShow) {
                selectedTVShow = localStorage.getItem('selectedTVShow');
            } else {
                // If tv_show was found in the URL, update localStorage
                localStorage.setItem('selectedTVShow', selectedTVShow);
            }
        
            // If still no tv_show, redirect to selection page
            if (!selectedTVShow) {
                alert('Please select a TV show first!');
                window.location.href = './SelectionPage.html';
                return;
            }
        
            // Now apply the selected TV show
            const gamePage = document.getElementById('game-page');
            gamePage.style.display = 'block';
        
            const backgroundImage = `HomePage/${selectedTVShow}_background.png`;
            gamePage.style.backgroundImage = `url('${backgroundImage}')`;
        
            applyLevelColors(selectedTVShow);
        
            setTimeout(scrollToBottom, 0);
        
            for (let i = 1; i <= 20; i++) {
                updateStars(i);
            }
        }        
        

        function submitLevel(level) {
            if (!selectedTVShow) {
                alert('Please select a TV show first!');
                window.location.href = 'SelectionPage.html';
                return;
            }
        
            // Construct the URL to the correct level file
            const url = `./level${level}/level${level}.html?tv_show=${encodeURIComponent(selectedTVShow)}`;
            window.location.href = url;
        }
        

        function movePlayerTo(targetLevel) {
            if (levelScores[targetLevel - 2] === 0 && targetLevel !== 1) {
                return;
            }

            const player = document.getElementById('player');
            const targetIndex = targetLevel - 1;
            let currentIndex = levelPositions.findIndex(pos => {
                return player.style.top === pos.top && player.style.left === pos.left;
            });

            if (currentIndex === -1) {
                currentIndex = 0;
            }

            function moveToNextLevel() {
                if (currentIndex === targetIndex) return;

                if (currentIndex < targetIndex) {
                    currentIndex++;
                } else {
                    currentIndex--;
                }

                player.style.top = levelPositions[currentIndex].top;
                player.style.left = levelPositions[currentIndex].left;

                setTimeout(moveToNextLevel, 1000);
            }

            moveToNextLevel();

            submitLevel(targetLevel);
        }

        function scrollToBottom() {
            const gamePage = document.getElementById('game-page');
            gamePage.scrollTop = gamePage.scrollHeight;
        }
    </script>
</body>
</html>
